# 验证码

手机验证码制作

# 1. 生成图片

[Python图片制作](./03-验证码.rar/captcha.rar), 生成并发送给前端的api

```python
@bp_validate.route("/image_code/")
def make_image():
    """图片验证制作"""
    logger.info("进入图片验证制作")
    code_id = request.args.get("uuid")                   # 从前端获取UUID
    random_str, answer, image = captcha.generate_captcha()  # 从模块中生成随机图片(随机字符串, 答案, 图片)
    image_key = "image_code_" + code_id                     # 把UUID当做key, answer作为value存入redis中
    # print(name, answer, redis_store)
    try:
        # 防止redis未打开
        redis_store.set(image_key, answer, IMAGE_CODE_REDIS_EXPIRES)  # 添加到redis中 k_v_lift'time
    except Exception as error:
        return jsonify(errno=RET.DATAERR, errmsg=error)
    # 二进制数据不能直接return, 需要用make_response转换
    response = make_response(image)
    response.header = {
        "Content-Type": "image/jpg"  # 添加格式: image/jpg格式
    }
    return response   
```



# 2. 验证

验证结果:

* 成功则发送手机验证码[[制作]]()
* 失败则删除uuid

```python
@bp_validate.route("/sms_code", methods=["POST"])
def make_sms():
    """短信验证码制作"""
    print("进入短信注册")
    dict_code = request.json
    print(dict_code)
    mobile = dict_code.get("mobile")
    image_code = dict_code.get("image_code")
    uuid = dict_code.get("uuid")
    # 非空判断
    if not all([mobile, image_code, uuid]):
        redis_store.delete("image_code_" + uuid)
        return jsonify(errno=RET.NODATA, errmsg="不能有空数据")
    # 手机号校验
    if not re.match(r"^1[35678]\d{9}$", mobile):
        redis_store.delete("image_code_" + uuid)
        return jsonify(errno=RET.DATAERR, errmsg="手机号输入有误, 请重试！")
    try:
        # 防止数据过期报错
        answer = redis_store.get("image_code_" + uuid)
    except Exception:
        redis_store.delete("image_code_" + uuid)
        return jsonify(errno=RET.DBERR, errmsg="图片已过期, 请刷新图片！")
    if image_code.upper() != answer.upper():
        redis_store.delete("image_code_" + uuid)
        return jsonify(errno=RET.PARAMERR, errmsg="验证码输入错误！")
    random_code = "%{}d".format(len(str(MOBILE_VALIDATE_MAX))) % random.randint(MOBILE_VALIDATE_MIN, MOBILE_VALIDATE_MAX)
    print(random_code)
    redis_store.set("sms_code_" + mobile, random_code, IMAGE_CODE_REDIS_EXPIRES)
    result = CCP().send_template_sms(mobile, [random_code, MOBILE_VALIDATE_EXPIRES], MOBILE_TEMPLATE)
    print("校验成功！")
    return jsonify(errno=RET.THIRDERR, errmsg="短信验证码发送失败, 请稍后重试！") if result else jsonify(errno=RET.OK, errmsg="ok")
```



