# 1. 磁盘介绍

## 1.1 Linux硬盘分区

MBR: Master Boot Record, 硬盘主引导记录.

硬盘的0柱面, 0磁头, 1扇区称为主引导扇区(主引导记录MBR). 由三部分组成:

* 主引导程序(boot loader), 占用446字节
* 硬盘分区表DPT(Disk Partition table), 占用64字节
* 分区标识符(55AA), 占用2字节.

linux规定: 逻辑分区必须建立在拓展分区之上, 不能建立在主分区之上.

一般分区编号介绍

* 主分区 1 - 4 
* 逻辑分区 5 +

GPT方式分区: 主分区没有限制

![image-20200718213153196](image/05-%E7%A3%81%E7%9B%98%E6%93%8D%E4%BD%9C/image-20200718213153196.png)

# 2. fdisk分区

```bash
fdisk [选项] device
```

常用参数

```bash
   a   toggle a bootable flag
   b   edit bsd disklabel
   c   toggle the dos compatibility flag
   d   delete a partition  # 删除分区
   g   create a new empty GPT partition table
   G   create an IRIX (SGI) partition table
   l   list known partition types  # 查看分区类型
   m   print this menu  # 打印帮助列表
   n   add a new partition  # 增加新分区
   o   create a new empty DOS partition table
   p   print the partition table  # 显示分区表
   q   quit without saving changes  # 不保存退出
   s   create a new empty Sun disklabel
   t   change a partition's system id   # 改变分区类型
   u   change display/entry units
   v   verify the partition table
   w   write table to disk and exit  # 保存退出
   x   extra functionality (experts only)
```



## 2.1 增加分区

### 2.1.1 增加分区

```bash
[root@localhost ~]# fdisk /dev/sdb
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Command (m for help): n  # 创建分区
Partition type:
   p   primary (0 primary, 0 extended, 4 free)  # 主分区
   e   extended									# 拓展分区
Select (default p): p  # 构建主分区
Partition number (1-4, default 1): 1    # 选择分区编号
First sector (2048-41943039, default 2048):   # 分区扇形引导位置
Using default value 2048
Last sector, +sectors or +size{K,M,G} (2048-41943039, default 41943039): # 设置分区大小, 指定的话可以用`+10G`表示
Using default value 41943039
Partition 1 of type Linux and of size 20 GiB is set

Command (m for help): p  # 查看分区信息

Disk /dev/sdb: 21.5 GB, 21474836480 bytes, 41943040 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0xe92d2ec3

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048    41943039    20970496   83  Linux  # 新增加的分区信息

Command (m for help): w   # 保存并退出
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.
[root@localhost ~]# fdisk /dev/sdb
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): m
Command action
   a   toggle a bootable flag
   b   edit bsd disklabel
   c   toggle the dos compatibility flag
   d   delete a partition
   g   create a new empty GPT partition table
   G   create an IRIX (SGI) partition table
   l   list known partition types
   m   print this menu
   n   add a new partition
   o   create a new empty DOS partition table
   p   print the partition table
   q   quit without saving changes
   s   create a new empty Sun disklabel
   t   change a partition's system id
   u   change display/entry units
   v   verify the partition table
   w   write table to disk and exit
   x   extra functionality (experts only)

Command (m for help): n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): p
Partition number (1-4, default 1): 1    
First sector (2048-41943039, default 2048): 
Using default value 2048
Last sector, +sectors or +size{K,M,G} (2048-41943039, default 41943039): 
Using default value 41943039
Partition 1 of type Linux and of size 20 GiB is set

Command (m for help): p

Disk /dev/sdb: 21.5 GB, 21474836480 bytes, 41943040 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0xe92d2ec3

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048    41943039    20970496   83  Linux

Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.
[root@localhost ~]# ls /dev/sdb*
/dev/sdb  /dev/sdb1
[root@localhost ~]
```

### 2.1.2 分区生效

未使用的分区, 无需此操作



使用的磁盘分区后, 提示如下:

```bash
WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.
```

处理方案:

1. 重启(最好是重启)
2. `partx -a /dev/sdb` 重新获取分区表

```bash
[root@localhost bak]# ls /dev/sdb*  # 新创建的分区没有加载  
/dev/sdb  /dev/sdb1  /dev/sdb4
[root@localhost bak]# partx -a /dev/sdb  # 刷新当前分区表
partx: /dev/sdb: error adding partition 1
partx: /dev/sdb: error adding partition 4
[root@localhost bak]# ls /dev/sdb*   # 成功读取到分区信息
/dev/sdb  /dev/sdb1  /dev/sdb2  /dev/sdb4
[root@localhost bak]#
```

## 2.2 磁盘格式

```bash
mkfs.ext4 -f /dev/sdb1  # 格式化为ext4文件系统
mkfs.xfs -f /dev/sdb1   # 格式化为xfs文件系统
```



## 2.3 删除分区

```bash
[root@localhost bak]# fdisk /dev/sdb
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Command (m for help): d  # 开始删除分区
Partition number (1,2,4, default 4): 1  # 指定需要删除的分区
Partition 1 is deleted

Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.

WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.
[root@localhost bak]# ls /dev/sdb*
/dev/sdb  /dev/sdb1  /dev/sdb2  /dev/sdb4  # 磁盘未同步, 需要重启才能解决
[root@localhost bak]# reboot

WARNING! The remote SSH server rejected X11 forwarding request.
Last login: Sat Jul 18 09:44:09 2020 from 10.0.0.1
[root@localhost ~]# ls /dev/sdb*
/dev/sdb  /dev/sdb2  /dev/sdb4  # 已经正常
[root@localhost ~]#
```



# 3. gdisk分区

主要用于大于2T的硬盘, 此分区采用GPT分区表. MBR分区表不支持4T以上的磁盘,  默认支持128个分区

```bash
gdisk [选项] device
```

## 3.1 配置分区

基本上操作和fdisk类似

```bash
[root@localhost /]# gdisk /dev/sdb
GPT fdisk (gdisk) version 0.8.10

Partition table scan:
  MBR: MBR only
  BSD: not present
  APM: not present
  GPT: not present


***************************************************************
Found invalid GPT and valid MBR; converting MBR to GPT format
in memory. THIS OPERATION IS POTENTIALLY DESTRUCTIVE! Exit by
typing 'q' if you don't want to convert your MBR partitions
to GPT format!
***************************************************************


Command (? for help): n
Partition number (1-128, default 1): 
First sector (34-41943006, default = 2048) or {+-}size{KMGTP}: 
Last sector (2048-41943006, default = 41943006) or {+-}size{KMGTP}: +1G
Current type is 'Linux filesystem'
Hex code or GUID (L to show codes, Enter = 8300): 
Changed type of partition to 'Linux filesystem'

Command (? for help): p
Disk /dev/sdb: 41943040 sectors, 20.0 GiB
Logical sector size: 512 bytes
Disk identifier (GUID): 5105A031-B436-4E4E-83D2-22CAF99A89AC
Partition table holds up to 128 entries
First usable sector is 34, last usable sector is 41943006
Partitions will be aligned on 2048-sector boundaries
Total free space is 39845821 sectors (19.0 GiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         2099199   1024.0 MiB  8300  Linux filesystem

Command (? for help): w

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
PARTITIONS!!

Do you want to proceed? (Y/N): y
OK; writing new GUID partition table (GPT) to /dev/sdb.
The operation has completed successfully.
[root@localhost /]# ls /dev/sdb*
/dev/sdb  /dev/sdb1
[root@localhost /]# mount /dev/sdb1 /root/bak
[root@localhost /]# df -Th
Filesystem              Type      Size  Used Avail Use% Mounted on
...
/dev/sdb1               xfs      1014M   33M  982M   4% /root/bak
[root@localhost /]#
```

## 3.2 删除分区

```bash
[root@localhost /]# umount /root/bak
[root@localhost /]# gdisk /dev/sdb
GPT fdisk (gdisk) version 0.8.10

Partition table scan:
  MBR: protective
  BSD: not present
  APM: not present
  GPT: present

Found valid GPT with protective MBR; using GPT.

Command (? for help): d
Using 1

Command (? for help): p
Disk /dev/sdb: 41943040 sectors, 20.0 GiB
Logical sector size: 512 bytes
Disk identifier (GUID): 5105A031-B436-4E4E-83D2-22CAF99A89AC
Partition table holds up to 128 entries
First usable sector is 34, last usable sector is 41943006
Partitions will be aligned on 2048-sector boundaries
Total free space is 41942973 sectors (20.0 GiB)

Number  Start (sector)    End (sector)  Size       Code  Name

Command (? for help): w

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
PARTITIONS!!

Do you want to proceed? (Y/N): y
OK; writing new GUID partition table (GPT) to /dev/sdb.
The operation has completed successfully.
[root@localhost /]# ls /dev/sdb*
/dev/sdb
[root@localhost /]#
```



# 4. 分区挂载

```bash
mount 分区 挂载目录
```

* -a: 自动加载`/etc/fstab`中未挂载的文件

  ```bash
  mount -a
  ```

## 4.1 分区挂载

```bash
mount /dev/sdb1 /root/test
```

## 4.2 分区卸载

```bash
umount /dev/sdb1
```

### 4.2.1 分区卸载失败处理

如果分区正在使用, 可能会提示卸载失败

```bash
[root@localhost bak]# umount /dev/sdb4
umount: /root/bak: target is busy.
        (In some cases useful info about processes that use
         the device is found by lsof(8) or fuser(1))
[root@localhost bak]#
```

方法一: 

```bash
[root@localhost ~]# lsof /root/bak
COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
bash    1237 root  cwd    DIR   8,20        6   64 /root/bak
[root@localhost ~]#
```

然后杀掉此进程即可

```bash
kill -9 1237
```

方法二:

```bash
[root@localhost ~]# fuser -k /root/bak  # 直接杀死使用的tty
/root/bak:            1237c
[root@localhost ~]#
```

然后在进行卸载即可



## 4.3 自动挂载

处理文件: `/etc/fstab`

### 4.3.1 配置挂载

打开: `vim /etc/fstab`

追加内容

```bash
/dev/cdrom              /mnt                    iso9660   defaults        0 0
```

* /dev/cdrom: 需要挂载的盘符, 也可以用分区的UUID

  ```bash
  [root@localhost ~]# blkid
  /dev/sda1: UUID="dd0c63c8-1bed-47db-a256-85ff1063836b" TYPE="xfs" 
  /dev/sda2: UUID="93ptLw-Skn1-bCKZ-OuRi-d8pt-bHco-spY5gc" TYPE="LVM2_member" 
  /dev/sdb4: UUID="437234ba-45c0-4497-81a3-7d34e6673f0b" TYPE="xfs" 
  /dev/sr0: UUID="2020-04-22-00-54-00-00" LABEL="CentOS 7 x86_64" TYPE="iso9660" PTTYPE="dos" 
  /dev/mapper/centos-root: UUID="3fb030fe-c1dc-4899-afb2-d29693996db7" TYPE="xfs" 
  /dev/mapper/centos-swap: UUID="fdb94e01-3aca-4f03-8d52-660d7b7fe780" TYPE="swap" 
  ```

* /mnt:  挂载的位置

* iso9660: 盘符格式, iso盘格式

* defaults: 控制权限等问题

  | 参数        | 说明                                 |
  | ----------- | ------------------------------------ |
  | Async/sync  | 设置同步方式运行, 默认为async        |
  | auto/noauto | 执行mount -a时, 此文件是否被自动挂载 |
  | rw/ro       | 是否以只读/只写默认挂载              |
  | exec/noexe  | 限制文件系统内能否执行               |
  | user/nouser | 是否允许用户挂载                     |
  | suid/nosuid | 是否允许suid存在                     |
  | Usrquota    | 启动文件系统支持磁盘配额模式         |
  | Grpquota    | 启动文件系统对群组磁盘配额模式       |
  | Defaults    | 同时具有以上全部属性                 |

* 0: 是否自动备份, 0不备份  

  | 参数 | 说明               |
  | ---- | ------------------ |
  | 0    | 不备份             |
  | 1    | 每天进行备份       |
  | 2    | 不定日期的进行备份 |

* 0: 是否检测磁盘完整性

  | 参数 | 说明                               |
  | ---- | ---------------------------------- |
  | 0    | 不检查                             |
  | 1    | 优先级最高的检验(一般根目录会选择) |
  | 2    | 1级别检验后再进行检验              |

手动刷新挂载项

```bash
mount -a  # 刷新挂载, 自动挂载未挂载的磁盘
df -Th    # 查看挂载项
```



### 4.3.1 自动挂载配置失败修复

一般自动挂载是失败, 可能会卡屏, 无法进入系统

![image-20200718233729222](image/05-%E7%A3%81%E7%9B%98%E6%93%8D%E4%BD%9C/image-20200718233729222.png)

修复方案:

![image-20200718234643483](image/05-%E7%A3%81%E7%9B%98%E6%93%8D%E4%BD%9C/image-20200718234643483.png)





# 5. 拓展swap分区

Swap分区在系统物理内存不够用时, 可以从硬盘中分出一部分来供给使用

**注意**: 一般到这一步时, 尽量去加内存, 而不是划分.

```bash
mkswap /devices   # 格式转化
swapon /swap      # 激活/swap, 加入到swap分区中
vim /etc/fstab    # 增加开机自动挂载

#删除分区 
swapoff /swap
```

## 5.1 磁盘swap分区

### 5.1.1 增加磁盘分区

参见磁盘分区

### 5.1.2 格式转换

```bash
[root@localhost ~]# mkswap /dev/sdb2
Setting up swapspace version 1, size = 18873320 KiB
no label, UUID=70baa221-a908-4aee-823a-45086292fc79
[root@localhost ~]#
```

### 5.1.3 设置交换分区

```bash
[root@localhost ~]# free -m
              total        used        free      shared  buff/cache   available
Mem:            972         137         724           7         110         706
Swap:          2047           0        2047
[root@localhost ~]# swapon /dev/sdb2
[root@localhost ~]# free -m
              total        used        free      shared  buff/cache   available
Mem:            972         151         710           7         110         691
Swap:         20478           0       20478
[root@localhost ~]# 
```

### 5.1.4 关闭交换分区

```bash
[root@localhost ~]# swapoff /dev/sdb2
[root@localhost ~]# free -m
              total        used        free      shared  buff/cache   available
Mem:            972         137         724           7         110         705
Swap:          2047           0        2047
[root@localhost ~]#
```



# 5.2 文件增加swap分区

### 5.2.1 创建流文件

```bash
[root@localhost ~]# dd if=/dev/zero of=swap_file bs=1M count=500
500+0 records in
500+0 records out
524288000 bytes (524 MB) copied, 3.26677 s, 160 MB/s
[root@localhost ~]#
```

* dd: copy一个文件, 并且在copy同时进行指定转换
* if: 指定输入文件
* of: 指定输出文件
* bs: 设置读取/输出的块大小   , bytes
* count: 指定读取大小, bytes

### 5.2.2 转换文件

```bash
mkswap -f /root/swap_file  # 转换为swap文件
chmod 0600 swap_file       # 指定文件权限
free -m                    # 查看当前内存
swapon /root/swap_file     # 挂载swap
swapoff /root/swap_file    # 卸载swap
```

效果展示

```bash
[root@localhost ~]# mkswap -f /root/swap_file
mkswap: /root/swap_file: warning: wiping old swap signature.
Setting up swapspace version 1, size = 511996 KiB
no label, UUID=d1adedff-d839-4dbb-a559-45ed179c854a
[root@localhost ~]# chmod 0600 swap_file 
[root@localhost ~]# swapon /root/swap_file
[root@localhost ~]# free -m
              total        used        free      shared  buff/cache   available
Mem:            972         136         729           7         106         709
Swap:          2547           0        2547
[root@localhost ~]# swapoff /root/swap_file
[root@localhost ~]# free -m
              total        used        free      shared  buff/cache   available
Mem:            972         135         729           7         106         709
Swap:          2047           0        2047
[root@localhost ~]#
```



