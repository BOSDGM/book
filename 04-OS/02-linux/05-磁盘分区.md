# 1. 磁盘介绍

## 1.1 Linux硬盘分区

MBR: Master Boot Record, 硬盘主引导记录.

硬盘的0柱面, 0磁头, 1扇区称为主引导扇区(主引导记录MBR). 由三部分组成:

* 主引导程序(boot loader), 占用446字节
* 硬盘分区表DPT(Disk Partition table), 占用64字节
* 分区标识符(55AA), 占用2字节.

linux规定: 逻辑分区必须建立在拓展分区之上, 不能建立在主分区之上.

一般分区编号介绍

* 主分区 1 - 4 
* 逻辑分区 5 +

GPT方式分区: 主分区没有限制

![image-20200718213153196](image/05-%E7%A3%81%E7%9B%98%E6%93%8D%E4%BD%9C/image-20200718213153196.png)

# 2. fdisk分区

```bash
fdisk [选项] device
```

常用参数

```bash
   a   toggle a bootable flag
   b   edit bsd disklabel
   c   toggle the dos compatibility flag
   d   delete a partition  # 删除分区
   g   create a new empty GPT partition table
   G   create an IRIX (SGI) partition table
   l   list known partition types  # 查看分区类型
   m   print this menu  # 打印帮助列表
   n   add a new partition  # 增加新分区
   o   create a new empty DOS partition table
   p   print the partition table  # 显示分区表
   q   quit without saving changes  # 不保存退出
   s   create a new empty Sun disklabel
   t   change a partition's system id   # 改变分区类型
   u   change display/entry units
   v   verify the partition table
   w   write table to disk and exit  # 保存退出
   x   extra functionality (experts only)
```



## 2.1 增加分区

### 2.1.1 增加分区

```bash
[root@localhost ~]# fdisk /dev/sdb
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Command (m for help): n  # 创建分区
Partition type:
   p   primary (0 primary, 0 extended, 4 free)  # 主分区
   e   extended									# 拓展分区
Select (default p): p  # 构建主分区
Partition number (1-4, default 1): 1    # 选择分区编号
First sector (2048-41943039, default 2048):   # 分区扇形引导位置
Using default value 2048
Last sector, +sectors or +size{K,M,G} (2048-41943039, default 41943039): # 设置分区大小, 指定的话可以用`+10G`表示
Using default value 41943039
Partition 1 of type Linux and of size 20 GiB is set

Command (m for help): p  # 查看分区信息

Disk /dev/sdb: 21.5 GB, 21474836480 bytes, 41943040 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0xe92d2ec3

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048    41943039    20970496   83  Linux  # 新增加的分区信息

Command (m for help): w   # 保存并退出
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.
[root@localhost ~]# fdisk /dev/sdb
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): m
Command action
   a   toggle a bootable flag
   b   edit bsd disklabel
   c   toggle the dos compatibility flag
   d   delete a partition
   g   create a new empty GPT partition table
   G   create an IRIX (SGI) partition table
   l   list known partition types
   m   print this menu
   n   add a new partition
   o   create a new empty DOS partition table
   p   print the partition table
   q   quit without saving changes
   s   create a new empty Sun disklabel
   t   change a partition's system id
   u   change display/entry units
   v   verify the partition table
   w   write table to disk and exit
   x   extra functionality (experts only)

Command (m for help): n
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
Select (default p): p
Partition number (1-4, default 1): 1    
First sector (2048-41943039, default 2048): 
Using default value 2048
Last sector, +sectors or +size{K,M,G} (2048-41943039, default 41943039): 
Using default value 41943039
Partition 1 of type Linux and of size 20 GiB is set

Command (m for help): p

Disk /dev/sdb: 21.5 GB, 21474836480 bytes, 41943040 sectors
Units = sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disk label type: dos
Disk identifier: 0xe92d2ec3

   Device Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048    41943039    20970496   83  Linux

Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.
Syncing disks.
[root@localhost ~]# ls /dev/sdb*
/dev/sdb  /dev/sdb1
[root@localhost ~]
```

### 2.1.2 分区生效

未使用的分区, 无需此操作



使用的磁盘分区后, 提示如下:

```bash
WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.
```

处理方案:

1. 重启(最好是重启)
2. `partx -a /dev/sdb` 重新获取分区表

```bash
[root@localhost bak]# ls /dev/sdb*  # 新创建的分区没有加载  
/dev/sdb  /dev/sdb1  /dev/sdb4
[root@localhost bak]# partx -a /dev/sdb  # 刷新当前分区表
partx: /dev/sdb: error adding partition 1
partx: /dev/sdb: error adding partition 4
[root@localhost bak]# ls /dev/sdb*   # 成功读取到分区信息
/dev/sdb  /dev/sdb1  /dev/sdb2  /dev/sdb4
[root@localhost bak]#
```

## 2.2 磁盘格式

```bash
mkfs.ext4 -f /dev/sdb1  # 格式化为ext4文件系统
mkfs.xfs -f /dev/sdb1   # 格式化为xfs文件系统
```



## 2.3 删除分区

```bash
[root@localhost bak]# fdisk /dev/sdb
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.

Command (m for help): d  # 开始删除分区
Partition number (1,2,4, default 4): 1  # 指定需要删除的分区
Partition 1 is deleted

Command (m for help): w
The partition table has been altered!

Calling ioctl() to re-read partition table.

WARNING: Re-reading the partition table failed with error 16: Device or resource busy.
The kernel still uses the old table. The new table will be used at
the next reboot or after you run partprobe(8) or kpartx(8)
Syncing disks.
[root@localhost bak]# ls /dev/sdb*
/dev/sdb  /dev/sdb1  /dev/sdb2  /dev/sdb4  # 磁盘未同步, 需要重启才能解决
[root@localhost bak]# reboot

WARNING! The remote SSH server rejected X11 forwarding request.
Last login: Sat Jul 18 09:44:09 2020 from 10.0.0.1
[root@localhost ~]# ls /dev/sdb*
/dev/sdb  /dev/sdb2  /dev/sdb4  # 已经正常
[root@localhost ~]#
```



# 3. gdisk分区

主要用于大于2T的硬盘, 此分区采用GPT分区表. MBR分区表不支持4T以上的磁盘,  默认支持128个分区

```bash
gdisk [选项] device
```

## 3.1 配置分区

基本上操作和fdisk类似

```bash
[root@localhost /]# gdisk /dev/sdb
GPT fdisk (gdisk) version 0.8.10

Partition table scan:
  MBR: MBR only
  BSD: not present
  APM: not present
  GPT: not present


***************************************************************
Found invalid GPT and valid MBR; converting MBR to GPT format
in memory. THIS OPERATION IS POTENTIALLY DESTRUCTIVE! Exit by
typing 'q' if you don't want to convert your MBR partitions
to GPT format!
***************************************************************


Command (? for help): n
Partition number (1-128, default 1): 
First sector (34-41943006, default = 2048) or {+-}size{KMGTP}: 
Last sector (2048-41943006, default = 41943006) or {+-}size{KMGTP}: +1G
Current type is 'Linux filesystem'
Hex code or GUID (L to show codes, Enter = 8300): 
Changed type of partition to 'Linux filesystem'

Command (? for help): p
Disk /dev/sdb: 41943040 sectors, 20.0 GiB
Logical sector size: 512 bytes
Disk identifier (GUID): 5105A031-B436-4E4E-83D2-22CAF99A89AC
Partition table holds up to 128 entries
First usable sector is 34, last usable sector is 41943006
Partitions will be aligned on 2048-sector boundaries
Total free space is 39845821 sectors (19.0 GiB)

Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         2099199   1024.0 MiB  8300  Linux filesystem

Command (? for help): w

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
PARTITIONS!!

Do you want to proceed? (Y/N): y
OK; writing new GUID partition table (GPT) to /dev/sdb.
The operation has completed successfully.
[root@localhost /]# ls /dev/sdb*
/dev/sdb  /dev/sdb1
[root@localhost /]# mount /dev/sdb1 /root/bak
[root@localhost /]# df -Th
Filesystem              Type      Size  Used Avail Use% Mounted on
...
/dev/sdb1               xfs      1014M   33M  982M   4% /root/bak
[root@localhost /]#
```

## 3.2 删除分区

```bash
[root@localhost /]# umount /root/bak
[root@localhost /]# gdisk /dev/sdb
GPT fdisk (gdisk) version 0.8.10

Partition table scan:
  MBR: protective
  BSD: not present
  APM: not present
  GPT: present

Found valid GPT with protective MBR; using GPT.

Command (? for help): d
Using 1

Command (? for help): p
Disk /dev/sdb: 41943040 sectors, 20.0 GiB
Logical sector size: 512 bytes
Disk identifier (GUID): 5105A031-B436-4E4E-83D2-22CAF99A89AC
Partition table holds up to 128 entries
First usable sector is 34, last usable sector is 41943006
Partitions will be aligned on 2048-sector boundaries
Total free space is 41942973 sectors (20.0 GiB)

Number  Start (sector)    End (sector)  Size       Code  Name

Command (? for help): w

Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING
PARTITIONS!!

Do you want to proceed? (Y/N): y
OK; writing new GUID partition table (GPT) to /dev/sdb.
The operation has completed successfully.
[root@localhost /]# ls /dev/sdb*
/dev/sdb
[root@localhost /]#
```



